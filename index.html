<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Particle Life</title>
    <script src="scripts/infrastructure/react.production.min.js"></script>
    <script src="scripts/infrastructure/react-dom.production.min.js"></script>
    <script src="scripts/infrastructure/babel.min.js"></script>
    <script src="scripts/infrastructure/p5.js"></script>
    <script src="scripts/apps/particles/config.particle.js"></script>
    <script src="scripts/apps/particles/particle.js"></script>
    <script src="scripts/apps/particles/app.particle-life.js"></script>
    <script src="scripts/apps/particles/sketch.particle-life.js"></script>

    <link href="css/awesome/css/fontawesome.min.css" rel="stylesheet" />
    <link href="css/awesome/css/brands.min.css" rel="stylesheet" />
    <link href="css/awesome/css/solid.min.css" rel="stylesheet" />

    <link href="css/styles.css" type="text/css" rel="stylesheet" />

    <script>
        // This is all the vanilla JS stuff. Basically, all the form element events/values
        // Should probably move this down to the react section at some point.
        console.warn("Index.html: " + (typeof app).toString());
        console.warn((app === null).toString());

        window.onresize = function() {
            // Inits the app in /scripts/apps/particles/sketch.particle-life.js
            setup();
        }

        function appIsGood() { 
            return typeof app !== "undefined" && !!app;
        }

        function onRangeViewChange(input, viewId) { 
            if (!input) return;
            const element = document.getElementById(viewId || "");
            if (!!element) element.innerHTML = input.value;
        }

        function onRangeChange(input, func) { 
            if (!input) return;
            if (typeof func !== "string") return;

            app[func](input.value);
        }

        function onSpawnModeChange(e) { 
            if (!appIsGood()) return;
            app.setSpawnMode(e.value);
        }

        function clearParticles() { 
            if (!appIsGood()) return;
            app.clear();
        }

    </script>
</head>

<body>
    <header>
        <div>
            <h1>
                <span>Particle Live</span>
                <span class="menu-item">
                    <span class="title">Settings</span>
                    <span class="panel">
                        <span class="content">
                            <ul>
                                <li>
                                    <span class="stack">
                                        <strong>Color Count: <strong id="color-count-value">4</strong></strong>
                                        <p>The number of <u>diffirent</u> colors. Max is 8.</p>
                                        <span><input type="range" min="1" max="8" value="4" onchange="onRangeChange(this, 'setColorCount')" oninput="onRangeViewChange(this, 'color-count-value')" class="slider" id="particle-count" /></span>
                                    </span>
                                </li>
                                <li>
                                    <span class="stack">
                                        <strong>Burst Count: <strong id="burst-value">100</strong></strong>
                                        <p>The number of particles spawned on right mouse click (left click spawns a single particle)</p>
                                        <span><input type="range" min="2" max="400" value="100" onchange="onRangeChange(this, 'setBurstCount')" oninput="onRangeViewChange(this, 'burst-value')" class="slider" id="particle-count" /></span>
                                    </span>
                                </li>
                                <li>
                                    <span class="stack">
                                        <strong>Spawn Mode:</strong>
                                        <p>This determines how particles spawn. Some cool effects going on here.</p>
                                        <span><select id="spawn-mode" onchange="onSpawnModeChange(this)">
                                            <option value="0">Right/Left Click</option>
                                            <option value="1">Mouse Drag</option>
                                        </select></span>
                                    </span>
                                </li>
                            </ul>
                        </span>
                    </span>
                </span>
                <span class="menu-item" id="settings">
                    <span class="title">Legend</span>
                    <span class="panel">
                        <span class="content" id="color-matrix"></span>
                    </span>
                </span>
                <span id="colors"></span>
                <span id="controls"></span>
            </h1>

            <nav>
                <ul>
                    <li><a href="https://www.jadecharles.com/" target="_jade"><i class="fa-solid fa-user"></i> JadeCharles.com</a></li>
                    <li><a href="https://www.penumbralabs.io" target="_pi"><i class="fa-solid fa-flask"></i> PenumbraLabs.io</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main id="main-canvas"></main>

    <footer>
        <p>v1.0.0</p>
    </footer>

    <script type="text/babel">
        // This is all the React UI stuff.

        function ParticleColorElements() {
            const [selectedIndex, setSelectedIndex] = React.useState(-1);

            const onClick = (index, e) => {
                if (!app) {
                    console.error("App is not initialized.");
                    return;
                }

                if (selectedIndex === index) { 
                    setSelectedIndex(-1);
                    return;
                }

                const color = ParticleConfig.colors[index];
                console.log(color.name);

                app.selectParticleColor(index);

                setSelectedIndex(index);
            }

            const colors = ParticleConfig.colors.map((color, index) => {
                const cn = index === selectedIndex ? "color selected" : "color";

                return (<span onClick={(e) => onClick(index, e)} key={"color-" + index} className={cn}>
                    <span style={{ backgroundColor: color.color }}></span>
                </span>);
            });

            return (<React.Fragment>{colors}</React.Fragment>);
        }

        function PayerControls() {
            const [viewState, setViewState] = React.useState(0);

            const refresh = () => { 
                const v = (viewState > 100) ? 0 : viewState;
                setViewState(viewState + 1);
            }

            const toggle = (e) => {
                if (!app) return;
                app.togglePlay();
                refresh();
            }

            const clear = (e) => {
                if (!app) return;
                app.clear();
                refresh();
            }

            const playButton = typeof app === "undefined" || !app || app.isRunning === true ? 
                (<i class="fa-solid fa-pause"></i>) :
                (<i class="fa-solid fa-play"></i>);

            return (<React.Fragment>
                <a onClick={() => toggle()} class="button" title="Toggle Play/Pause">{ playButton }</a>
                <a onClick={() => clear()} class="button" title="Clear Canvas"><i class="fa-solid fa-trash-can"></i></a>
            </React.Fragment>);
        }

        function ColorMatrixTable() {
            const [viewState, setViewState] = React.useState(0);
            const [editCell, setEditCell] = React.useState({ i: -1, j: -1 });
            const attractionValueRef = React.useRef();

            React.useEffect(() => { 
                if (typeof app === "undefined" || !app) return;
            }, [editCell]);

            if (viewState < -20) {
                return (<React.Fragment>Failed to load</React.Fragment>);
            }

            if (typeof app === "undefined" || !app) { 
                setTimeout(() => {
                    console.log("App is not initialized. Retrying..");
                    setViewState(viewState - 1);
                }, 500);
            } else {
                if (typeof app.onMatrixUpdate !== "function")
                    app.onMatrixUpdate = () => setViewState(viewState + 1);

                if (viewState <= 0) setViewState(1);
            }

            const saveAttractionValue = (e) => {
                if (!app) return;
                if (editCell.i < 0 || editCell.j < 0) return;

                const v = parseFloat(attractionValueRef.current.value + "");

                if (!isNaN(v)) {
                    console.log("Saved Value: " + v);
                    app.setAttractionValue(editCell.i, editCell.j, v);
                } else console.warn("Bad Value: " + v);

                setEditCell({ i: -1, j: -1 });
            }

            const createInput = (i, j) => {
                const value = app.attractionMatrix[i][j];
                const onChange = (e) => {
                    const v = parseFloat(e.target.value);
                    app.attractionMatrix[i][j] = v;
                    app.updateAttractionMatrix();
                    setViewState(viewState + 1);
                }

                return (<span className="edit-value"><input onBlur={() => saveAttractionValue()} type="number" step="0.01" min="-1" max="1" defaultValue={value} ref={attractionValueRef} /></span>);
            }

            const createTable = (app) => {
                if (!app || !app.attractionMatrix) return;

                const table = [];
                const colors = ParticleConfig.colors;
                
                if (!Array.isArray(colors)) return;

                const header = [<td key={"color-matrix-header"}>.</td>];

                for (let i = 0; i < colors.length; i++) {
                    const color = colors[i].color;
                    const style = { backgroundColor: color };
                    header.push(<td key={"color-header-item-" + i}><span style={style} className="legend-color"></span></td>);
                }

                table.push(<tr key={"color-matrix-header"}>{header}</tr>);

                for (let i = 0; i < colors.length; i++) {
                    let style = { backgroundColor: colors[i].color };
                    const row = [<td key={"color-matrix-row" + i}><span style={style} className="legend-color"></span></td>];

                    for (let j = 0; j < colors.length; j++) {
                        const value = app.attractionMatrix[i][j];
                        row.push(<td onClick={() => setEditCell({ i, j })} key={"color-matrix-" + i + "-" + j}>{ value.toFixed(2) }</td>);
                    }
                    table.push(<tr key={"color-matrix-row-" + i}>{row}</tr>);
                }

                return (<table className={"matrix"}>{ table }</table>);
            }

            const setMatrixKey = (key) => {
                if (typeof app === "undefined" || !app) return;
                app.setAttractionMatrix(key);
                setViewState(viewState + 1);
            }

            const table = viewState > 0 ? 
                createTable(app) :
                null;

            if (table === null) return (<span>Loading...</span>);

            const editElement = editCell.j >= 0 && editCell.i >= 0 ? 
                createInput(editCell.i, editCell.j) :
                null;

            return (<React.Fragment>
                <h3>Attraction Values</h3>
                { table }
                <span id="legend-menu">
                    <a onClick={() => setMatrixKey("r")}>Random (R)</a>
                    <a onClick={() => setMatrixKey("u")}>Uniform (U)</a>
                    <a onClick={() => setMatrixKey("i")}>Identity (I)</a>
                    <a onClick={() => setMatrixKey("z")}>Zero (Z)</a>
                </span>
                { editElement }
            </React.Fragment>);
        }

        ReactDOM.render(
            <ParticleColorElements />,
            document.getElementById('colors')
        );

        ReactDOM.render(
            <PayerControls />,
            document.getElementById('controls')
        )

        ReactDOM.render(
            <ColorMatrixTable />,
            document.getElementById('color-matrix')
        );

    </script>
</body>

</html>
